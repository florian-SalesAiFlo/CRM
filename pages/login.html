<!-- ========================================================
     pages/login.html — Partial chargé dans #app par router.js
     CSS et Supabase SDK déjà disponibles via index.html.
     ======================================================== -->

<div class="login-page">

  <!-- Branding -->
  <div class="login-brand">
    <div class="login-logo">
      <svg viewBox="0 0 28 28" fill="none" aria-hidden="true">
        <rect width="28" height="28" rx="6" fill="#2d5be3"/>
        <path d="M7 14l5 5 9-10" stroke="#fff" stroke-width="2.5"
              stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
    <span class="login-brand-name">M2BPO</span>
    <p class="login-brand-sub">CRM Marchés Publics</p>
  </div>

  <!-- Card formulaire -->
  <div class="login-card" role="main">
    <h1 class="login-title">Connexion</h1>

    <!-- Zone d'erreur (masquée par défaut) -->
    <div class="login-error" id="login-error" role="alert" aria-live="assertive" hidden>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="8" x2="12" y2="12"/>
        <line x1="12" y1="16" x2="12.01" y2="16"/>
      </svg>
      <span id="login-error-msg"></span>
    </div>

    <!-- Formulaire -->
    <form id="login-form" novalidate>

      <div class="login-field">
        <label class="login-label" for="login-email">Adresse email</label>
        <input
          class="login-input"
          id="login-email"
          type="email"
          name="email"
          autocomplete="email"
          placeholder="vous@exemple.com"
          required
          autofocus
        >
      </div>

      <div class="login-field">
        <label class="login-label" for="login-password">Mot de passe</label>
        <div class="login-input-wrap">
          <input
            class="login-input"
            id="login-password"
            type="password"
            name="password"
            autocomplete="current-password"
            placeholder="••••••••"
            required
          >
          <button
            type="button"
            class="login-eye"
            id="login-eye"
            aria-label="Afficher le mot de passe"
            title="Afficher / masquer"
          >
            <svg id="login-eye-icon" viewBox="0 0 24 24" fill="none"
                 stroke="currentColor" stroke-width="2" aria-hidden="true">
              <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"/>
              <circle cx="12" cy="12" r="3"/>
            </svg>
          </button>
        </div>
      </div>

      <button type="submit" class="login-btn" id="login-btn">
        <span id="login-btn-text">Se connecter</span>
        <svg id="login-spinner" viewBox="0 0 24 24" fill="none"
             stroke="currentColor" stroke-width="2" hidden aria-hidden="true" style="display:none">
          <path d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" opacity=".25"/>
          <path d="M21 12a9 9 0 00-9-9" stroke-linecap="round"/>
        </svg>
      </button>

    </form>
  </div>

  <!-- Footer discret -->
  <p class="login-footer">© 2025 M2BPO — Accès réservé aux utilisateurs autorisés</p>

</div>

<style>
  .login-page {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: var(--space-6);
    background: var(--color-bg);
    padding: var(--space-6);
  }

  /* ── Branding ── */
  .login-brand {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-2);
  }
  .login-logo {
    width: 52px;
    height: 52px;
    filter: drop-shadow(0 4px 12px rgba(45, 91, 227, .3));
  }
  .login-logo svg { width: 100%; height: 100%; }
  .login-brand-name {
    font-size: var(--text-xl);
    font-weight: 700;
    letter-spacing: -.03em;
    color: var(--color-text);
  }
  .login-brand-sub {
    font-size: var(--text-sm);
    color: var(--color-text-tertiary);
    margin: 0;
  }

  /* ── Card ── */
  .login-card {
    width: 100%;
    max-width: 380px;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--space-8);
    box-shadow: var(--shadow-md);
  }
  .login-title {
    font-size: var(--text-xl);
    font-weight: 700;
    letter-spacing: -.03em;
    margin-bottom: var(--space-6);
    color: var(--color-text);
  }

  /* ── Erreur ── */
  .login-error[hidden] { display: none; }
  .login-error {
    display: flex;
    align-items: flex-start;
    gap: var(--space-2);
    background: var(--color-danger-soft);
    border: 1px solid #f5c2c7;
    border-radius: var(--radius-sm);
    padding: var(--space-3) var(--space-4);
    margin-bottom: var(--space-5);
    font-size: var(--text-sm);
    color: var(--color-danger);
    line-height: 1.5;
  }
  .login-error svg {
    width: 16px;
    height: 16px;
    flex-shrink: 0;
    margin-top: 1px;
  }

  /* ── Champs ── */
  .login-field { margin-bottom: var(--space-4); }
  .login-label {
    display: block;
    font-size: var(--text-sm);
    font-weight: 500;
    color: var(--color-text-secondary);
    margin-bottom: var(--space-2);
  }
  .login-input-wrap { position: relative; }
  .login-input {
    width: 100%;
    font-family: var(--font-sans);
    font-size: var(--text-base);
    color: var(--color-text);
    background: var(--color-surface);
    border: 1px solid var(--color-border-strong);
    border-radius: var(--radius-sm);
    padding: var(--space-3) var(--space-4);
    transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
    outline: none;
  }
  .login-input:focus {
    border-color: var(--color-primary);
    box-shadow: var(--shadow-focus);
  }
  .login-input.is-error { border-color: var(--color-danger); }
  .login-input-wrap .login-input { padding-right: 2.75rem; }
  .login-eye {
    position: absolute;
    right: var(--space-3);
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    cursor: pointer;
    color: var(--color-text-tertiary);
    padding: var(--space-1);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: color var(--transition-fast);
  }
  .login-eye:hover { color: var(--color-text-secondary); }
  .login-eye svg   { width: 18px; height: 18px; }

  /* ── Bouton submit ── */
  .login-btn {
    width: 100%;
    margin-top: var(--space-2);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    background: var(--color-primary);
    color: #fff;
    border: none;
    border-radius: var(--radius-sm);
    font-family: var(--font-sans);
    font-size: var(--text-base);
    font-weight: 600;
    padding: var(--space-3) var(--space-4);
    cursor: pointer;
    transition: background var(--transition-fast), transform var(--transition-fast),
                box-shadow var(--transition-fast), opacity var(--transition-fast);
  }
  .login-btn:hover:not(:disabled) {
    background: var(--color-primary-hover);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(45, 91, 227, .3);
  }
  .login-btn:disabled { opacity: .65; cursor: not-allowed; }
  .login-btn svg {
    width: 18px;
    height: 18px;
    animation: spin .8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ── Footer ── */
  .login-footer {
    font-size: var(--text-xs);
    color: var(--color-text-tertiary);
    text-align: center;
    margin: 0;
  }
</style>

<script type="module">
  import { login } from './js/auth.js';

  const form     = document.getElementById('login-form');
  const emailEl  = document.getElementById('login-email');
  const passEl   = document.getElementById('login-password');
  const errorBox = document.getElementById('login-error');
  const errorMsg = document.getElementById('login-error-msg');
  const btn      = document.getElementById('login-btn');
  const btnText  = document.getElementById('login-btn-text');
  const spinner  = document.getElementById('login-spinner');
  const eyeBtn   = document.getElementById('login-eye');

  eyeBtn.addEventListener('click', () => {
    const isHidden = passEl.type === 'password';
    passEl.type = isHidden ? 'text' : 'password';
    eyeBtn.setAttribute('aria-label', isHidden ? 'Masquer le mot de passe' : 'Afficher le mot de passe');
  });

  [emailEl, passEl].forEach(el => el.addEventListener('input', hideError));

  form.addEventListener('submit', handleSubmit);

  async function handleSubmit(e) {
    e.preventDefault();
    hideError();

    const email    = emailEl.value.trim();
    const password = passEl.value;

    if (!validateInputs(email, password)) return;

    setLoading(true);
    const { error } = await login(email, password);
    setLoading(false);

    if (error) { showError(mapErrorMessage(error)); return; }

    window.location.hash = '/prospects';
  }

  function validateInputs(email, password) {
    if (!email || !email.includes('@')) {
      showError('Adresse email invalide.');
      emailEl.classList.add('is-error');
      emailEl.focus();
      return false;
    }
    if (!password || password.length < 1) {
      showError('Le mot de passe est requis.');
      passEl.classList.add('is-error');
      passEl.focus();
      return false;
    }
    return true;
  }

  function mapErrorMessage(error) {
    const code = error?.code ?? '';
    const msg  = error?.message ?? '';
    switch (code) {
      case 'invalid_credentials':  return 'Email ou mot de passe incorrect.';
      case 'email_not_confirmed':  return 'Votre email n\'a pas encore été confirmé. Vérifiez votre boîte mail.';
      case 'user_not_found':       return 'Aucun compte associé à cet email.';
      case 'too_many_requests':    return 'Trop de tentatives. Réessayez dans quelques minutes.';
      default:                     return msg || 'Une erreur est survenue. Réessayez.';
    }
  }

  function showError(message) {
    errorMsg.textContent = message;
    errorBox.hidden = false;
  }

  function hideError() {
    errorBox.hidden = true;
    [emailEl, passEl].forEach(el => el.classList.remove('is-error'));
  }

  function setLoading(loading) {
    btn.disabled        = loading;
    btnText.textContent = loading ? 'Connexion…' : 'Se connecter';
    spinner.hidden      = !loading;
  }
</script>
